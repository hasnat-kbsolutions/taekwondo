import{r as n,W as ge,j as e,Y as ye,b as u,y as x}from"./app-Qc4CeIVR.js";import{A as ve,t as f,D as Ne,a as be,b as we,c as o}from"./authenticated-layout-ky9aO383.js";import{B as d}from"./button-C_h6ToX0.js";import{B as Ce}from"./badge-GE5GUWPt.js";import{S as v,a as N,b,c as w,e as m}from"./select-C0cthBOg.js";import{D as H,a as W,b as q,c as X,d as G,e as F}from"./dialog-DvqGXoYj.js";import{D as Se}from"./DataTable-sBZnSdCx.js";import{C as De,a as Ae,b as Me,c as _e}from"./card-aGJSTTtW.js";import{L as p}from"./label-B7U_IG_r.js";import{F as Q,U as Z}from"./upload-RNLxZv0Z.js";import{D as ee}from"./download-CYA-a4cB.js";import{T as ae}from"./trash-2-Ca9vEPzt.js";import{C as te}from"./circle-x-CJ-FCGfy.js";import{E as ke}from"./ellipsis-_bRBEkQo.js";import{E as Ue}from"./eye-Bj69TqAJ.js";import{S as Ee}from"./square-pen-QhbxiAVX.js";import{C as Fe}from"./circle-check-big-BLgVG8t6.js";import{F as Re}from"./file-text-BEBqe29o.js";import"./input-iz2NDNEj.js";import"./separator-CgvCt5_y.js";import"./index-CnUrj3gZ.js";import"./createLucideIcon-775Dkrg4.js";import"./building-2-BOzU0Xrn.js";import"./users-AXSi9GuI.js";import"./log-out-D5ccv8f0.js";import"./calendar-CZxiGZ8L.js";import"./sun-C1Um4luV.js";import"./index-8jmc5Owj.js";import"./index-D46JdVQV.js";import"./chevron-down-Cz7cvS-S.js";import"./table-B63i6qjq.js";const Ye=new Date().getFullYear(),Te=["All",...Array.from({length:5},(R,c)=>(Ye-c).toString())],Be=[{label:"January",value:"01"},{label:"February",value:"02"},{label:"March",value:"03"},{label:"April",value:"04"},{label:"May",value:"05"},{label:"June",value:"06"},{label:"July",value:"07"},{label:"August",value:"08"},{label:"September",value:"09"},{label:"October",value:"10"},{label:"November",value:"11"},{label:"December",value:"12"}];function pa({payments:R,filters:c,currencies:se}){var J,$,z;const[C,Y]=n.useState(c.status||""),[S,T]=n.useState(c.payment_month?c.payment_month.length===4?c.payment_month:c.payment_month.split("-")[0]:"All"),[D,A]=n.useState(((J=c.payment_month)==null?void 0:J.split("-")[1])||""),[M,B]=n.useState(c.currency_code||""),le=(a,s)=>{const l=Number(a)||0;return s==="JPY"?l.toLocaleString():l.toFixed(2)},[r,ne]=n.useState(null),[re,_]=n.useState(!1),[t,k]=n.useState(null),[ie,j]=n.useState(!1),[I,g]=n.useState(null),[h,U]=n.useState(null),{data:L,setData:ce,processing:V,errors:O,reset:E}=ge({attachment:null}),de=a=>{ne(a),_(!0)},P=a=>{var l;const s=(l=a.target.files)==null?void 0:l[0];if(U(s||null),s){if(s.type.startsWith("image/")){const i=new FileReader;i.onloadend=()=>{g(i.result)},i.readAsDataURL(s)}else g(null);ce("attachment",s)}},oe=()=>{var s;if(!L.attachment||!t){f.error("Please select a file to upload");return}const a=new FormData;a.append("attachment",L.attachment),(s=t.attachment)!=null&&s.id&&a.append("replace_attachment_id",t.attachment.id.toString()),x.post(route("admin.payments.upload-attachment",{payment:t.id}),a,{onSuccess:()=>{f.success(t.attachment?"Attachment updated successfully":"Attachment uploaded successfully"),j(!1),g(null),U(null),E(),x.reload({only:["payments"]})},onError:()=>{f.error("Failed to upload attachment")}})},me=()=>{t!=null&&t.attachment&&confirm("Are you sure you want to delete this attachment?")&&x.delete(route("admin.payments.delete-attachment",{attachment:t.attachment.id}),{onSuccess:()=>{f.success("Attachment deleted successfully"),j(!1),k(null),x.reload({only:["payments"]})},onError:()=>{f.error("Failed to delete attachment")}})},he=({year:a,month:s,status:l,currency:i})=>{const y=a==="All"?"":s?`${a}-${s}`:a;console.log("Filter Values:",{year:a,month:s,status:l,currency:i,paymentMonth:y}),x.get(route("admin.payments.index"),{status:l||null,payment_month:y||null,currency_code:i||null},{preserveScroll:!0,preserveState:!0,replace:!0})},[ue,xe]=n.useState(!0);n.useEffect(()=>{if(ue){xe(!1);return}he({year:S,month:D,status:C,currency:M})},[S,D,C,M]);const pe=()=>{Y(""),T("All"),A(""),B(""),x.get(route("admin.payments.index"),{},{preserveScroll:!0,preserveState:!1,replace:!0})},je=[{header:"#",cell:({row:a})=>a.index+1},{header:"Student",cell:({row:a})=>{var s;return((s=a.original.student)==null?void 0:s.name)||"-"}},{header:"Amount",cell:({row:a})=>{var K;const s=a.original,l=s.amount,i=s.currency_code,y=((K=s.currency)==null?void 0:K.symbol)||i,fe=le(l,i);return e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium",children:[i==="MYR"?"RM ":y,fe]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i})]})}},{header:"Status",cell:({row:a})=>e.jsx(Ce,{variant:a.original.status==="paid"||a.original.status==="success"?"default":"destructive",children:a.original.status})},{header:"Method",accessorKey:"method"},{header:"Payment Month",accessorKey:"payment_month"},{header:"Pay At",accessorKey:"pay_at"},{header:"Proof",cell:({row:a})=>{const s=a.original;return e.jsx("div",{className:"flex items-center gap-2",children:s.attachment?e.jsx(Q,{className:"w-4 h-4 text-primary"}):e.jsx(te,{className:"w-4 h-4 text-muted-foreground"})})}},{header:"Actions",cell:({row:a})=>e.jsxs(Ne,{children:[e.jsx(be,{asChild:!0,children:e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",children:e.jsx(ke,{className:"h-4 w-4"})})}),e.jsxs(we,{align:"end",children:[e.jsxs(o,{onClick:()=>de(a.original),children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"})," View"]}),e.jsx(o,{asChild:!0,children:e.jsxs(u,{href:route("admin.payments.edit",a.original.id),children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"})," Edit"]})}),a.original.status==="unpaid"&&e.jsx(o,{asChild:!0,children:e.jsxs(u,{href:route("admin.payments.updateStatus",a.original.id),method:"patch",data:{status:"paid"},as:"button",children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"})," ","Mark as Paid"]})}),(a.original.status==="paid"||a.original.status==="success")&&e.jsx(o,{asChild:!0,children:e.jsxs(u,{href:route("admin.payments.updateStatus",a.original.id),method:"patch",data:{status:"unpaid"},as:"button",children:[e.jsx(te,{className:"w-4 h-4 mr-2"})," Mark as Unpaid"]})}),e.jsxs(o,{onClick:s=>{s.preventDefault(),k(a.original),j(!0)},children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),a.original.attachment?"Manage":"Upload"," ","Proof"]}),e.jsx(o,{asChild:!0,children:e.jsxs(u,{href:route("admin.payments.destroy",a.original.id),method:"delete",as:"button",children:[e.jsx(ae,{className:"w-4 h-4 mr-2"})," Delete"]})}),e.jsx(o,{asChild:!0,children:e.jsxs(u,{href:route("invoice.show",{payment:a.original.id}),children:[e.jsx(Re,{className:"w-4 h-4 mr-2"})," Invoice"]})}),e.jsxs(o,{onClick:s=>{s.preventDefault();const l=route("invoice.download",{payment:a.original.id});window.open(l,"_blank")},children:[e.jsx(ee,{className:"w-4 h-4 mr-2"})," Download Invoice"]})]})]})}];return e.jsxs(ve,{header:"Payments",children:[e.jsx(ye,{title:"Payments"}),e.jsxs("div",{className:"container mx-auto py-10",children:[e.jsxs(De,{children:[e.jsxs(Ae,{className:"flex flex-row items-center justify-between",children:[e.jsx(Me,{children:"Payments"}),e.jsx(u,{href:route("admin.payments.create"),children:e.jsx(d,{children:"Add Payment"})})]}),e.jsxs(_e,{children:[e.jsx("div",{className:"mb-6 p-4 border rounded-lg bg-muted/50",children:e.jsxs("div",{className:"flex items-end gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex flex-col w-[160px]",children:[e.jsx(p,{className:"text-sm mb-1",children:"Year"}),e.jsxs(v,{value:S,onValueChange:a=>{T(a),a==="All"&&A("")},children:[e.jsx(N,{children:e.jsx(b,{placeholder:"Year"})}),e.jsx(w,{children:Te.map(a=>e.jsx(m,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"flex flex-col w-[160px]",children:[e.jsx(p,{className:"text-sm mb-1",children:"Month"}),e.jsxs(v,{value:D,onValueChange:a=>A(a==="all"?"":a),children:[e.jsx(N,{children:e.jsx(b,{placeholder:"Month"})}),e.jsxs(w,{children:[e.jsx(m,{value:"all",children:"All"}),Be.map(a=>e.jsx(m,{value:a.value,children:a.label},a.value))]})]})]}),e.jsxs("div",{className:"flex flex-col w-[160px]",children:[e.jsx(p,{className:"text-sm mb-1",children:"Status"}),e.jsxs(v,{value:C,onValueChange:a=>Y(a==="all"?"":a),children:[e.jsx(N,{children:e.jsx(b,{placeholder:"All Statuses"})}),e.jsxs(w,{children:[e.jsx(m,{value:"all",children:"All"}),e.jsx(m,{value:"paid",children:"Paid"}),e.jsx(m,{value:"unpaid",children:"Unpaid"})]})]})]}),e.jsxs("div",{className:"flex flex-col w-[160px]",children:[e.jsx(p,{className:"text-sm mb-1",children:"Currency"}),e.jsxs(v,{value:M,onValueChange:a=>B(a==="all"?"":a),children:[e.jsx(N,{children:e.jsx(b,{placeholder:"All Currencies"})}),e.jsxs(w,{children:[e.jsx(m,{value:"all",children:"All"}),se.map(a=>e.jsxs(m,{value:a.code,children:[a.code," -"," ",a.symbol]},a.code))]})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(d,{variant:"secondary",onClick:pe,children:"Reset Filters"})})]})}),e.jsx(Se,{data:R,columns:je})]})]}),e.jsx(H,{open:re,onOpenChange:_,children:e.jsxs(W,{className:"w-full",children:[e.jsxs(q,{children:[e.jsx(X,{className:"text-3xl text-foreground",children:"Edit Payment"}),e.jsx(G,{className:"text-muted-foreground",children:"Update payment details like amount and status."})]}),r&&e.jsxs("div",{className:"space-y-2 text-sm ",children:[e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Student:"})," ",($=r.student)==null?void 0:$.name]}),e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Amount:"})," ",((z=r.currency)==null?void 0:z.symbol)||"RM"," ",r.amount," (",r.currency_code,")"]}),e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Status:"})," ",r.status]}),e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Method:"})," ",r.method]}),e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Payment Month:"})," ",r.payment_month]}),e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Pay At:"})," ",r.pay_at]}),r.notes&&e.jsxs("p",{className:"flex justify-between",children:[e.jsx("strong",{children:"Notes:"})," ",r.notes]})]}),e.jsx(F,{children:e.jsx(d,{onClick:()=>_(!1),children:"Close"})})]})}),e.jsx(H,{open:ie,onOpenChange:j,children:e.jsxs(W,{className:"max-w-2xl",children:[e.jsxs(q,{children:[e.jsx(X,{children:t!=null&&t.attachment?"Update Payment Proof":"Upload Payment Proof"}),e.jsx(G,{children:"Upload an image or PDF as proof of payment. Max 5MB."})]}),e.jsxs("div",{className:"space-y-4",children:[(t==null?void 0:t.attachment)&&!h&&e.jsxs("div",{className:"space-y-3 p-4 border rounded-lg bg-muted/50",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx(Q,{className:"w-5 h-5 text-primary"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:t.attachment.original_filename}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.attachment.file_type.toUpperCase()})]})]})}),t.attachment.file_type.match(/^(jpg|jpeg|png|gif|webp)$/i)&&e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("img",{src:`/storage/${t.attachment.file_path}`,alt:"Current proof",className:"w-full h-auto max-h-64 object-contain bg-white"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>{t!=null&&t.attachment&&window.open(route("admin.payments.download-attachment",{attachment:t.attachment.id}),"_blank")},children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Download"]}),e.jsxs(d,{size:"sm",variant:"destructive",className:"flex-1",onClick:me,children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]}),I&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Preview"}),e.jsx("div",{className:"border rounded-lg overflow-hidden bg-muted/50",children:e.jsx("img",{src:I,alt:"Preview",className:"w-full h-auto max-h-64 object-contain"})})]}),(!(t!=null&&t.attachment)||h)&&e.jsxs("form",{onSubmit:a=>{a.preventDefault(),oe()},children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(p,{htmlFor:"attachment",children:"Select File"}),e.jsx("input",{id:"attachment",type:"file",accept:".jpg,.jpeg,.png,.pdf",onChange:P,className:"file:border-0 file:bg-primary file:text-primary-foreground file:rounded-md file:px-4 file:py-2 file:mr-4 text-sm"}),O.attachment&&e.jsx("p",{className:"text-sm text-red-600",children:O.attachment})]})}),e.jsxs(F,{className:"gap-2 mt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>{h?(U(null),g(null),E()):(j(!1),k(null),E())},children:h?"Cancel":"Close"}),h&&e.jsx(d,{type:"submit",disabled:V,children:V?"Uploading...":t!=null&&t.attachment?"Replace":"Upload"})]})]}),e.jsx("input",{id:"attachment-hidden",type:"file",accept:".jpg,.jpeg,.png,.pdf",onChange:P,className:"hidden"}),(t==null?void 0:t.attachment)&&!h&&e.jsx(F,{children:e.jsxs(d,{variant:"outline",onClick:()=>{var a;(a=document.getElementById("attachment-hidden"))==null||a.click()},children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Replace with New File"]})})]})]})})]})]})}export{pa as default};
